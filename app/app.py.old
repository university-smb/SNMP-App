
from flask import Flask, render_template, request, session, redirect, send_from_directory
import json



# import functions

from connect import *



app = Flask(__name__)

# secret key for session (mandatory)
app.secret_key = "session is used in this application!"



@app.route('/', methods=['GET', 'POST'])
def index():
    return render_template('index.html')


@app.route('/equipement', methods=['GET', 'POST'])
def equipemnts():

    con = create_connection('BDD/database.db')
    con.row_factory = sqlite3.Row
    
    cur = con.cursor()
    cur.execute("select * from equipements")

    data = cur.fetchall()

    close_connection(con)

    return render_template('equipements.html', rows=data)


@app.route('/equipement/add-equipement', methods=['GET', 'POST'])
def add_equipemnts():
    return render_template('add_equipement.html')



@app.route('/equipement/create-equipement', methods=['POST'])
def create_equipemnts():
    data = request.form.to_dict()

    
    try:
        conn = create_connection('BDD/database.db')
        cur = conn.cursor()

        cur.execute("INSERT INTO equipements (constructeur,type_de_material,ipdns,description,level) VALUES(?,?,?,?,?)",(data['constructeur'],data['type_de_material'],data['ipdns'],data['description'],data['level']))
        conn.commit()
        msg = "Record successfully added"

    except:
        conn.rollback()
        msg = "error in insert operation"
    finally:
        #return render_template("result.html",msg = msg)
        close_connection(conn)
        return redirect('/equipement')
        
    


    

    #return render_template('add_equipement.html')



@app.route('/equipement/<equip_id>/edit-equipement', methods=['GET', 'POST'])
def edit_equipemnts(equip_id):
    equip_id = equip_id

    try:
        conn = create_connection('BDD/database.db')
        cur = conn.cursor()

        cur.execute("select * from equipements where id=?", [equip_id])

        data = cur.fetchall()

        msg = "Record successfully added"

    except:
        conn.rollback()
        msg = "error in insert operation"
    finally:
        #return render_template("result.html",msg = msg)
        close_connection(conn)
        return render_template('edit_equipement.html', data=data)



@app.route('/equipement/update-equipement', methods=['POST'])
def update_equipemnts():
    data = request.form.to_dict()

    try:
        conn = create_connection('BDD/database.db')
        cur = conn.cursor()

        sql_update_query = """UPDATE equipements SET constructeur=?,type_de_material=?,ipdns=?,description=?,level=? WHERE id=?"""
        data = (data['constructeur'],data['type_de_material'],data['ipdns'],data['description'],data['level'], data['id'])

        print(data)

        cur.execute(sql_update_query, data)
        conn.commit()
        msg = "Record successfully added"

    except:
        conn.rollback()
        msg = "error in insert operation"
    finally:
        #return render_template("result.html",msg = msg)
        close_connection(conn)
        return redirect('/equipement')


# lancement de serveur WEB
if __name__ == '__main__':

    #Run web server for APP
    app.run()

